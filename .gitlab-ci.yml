variables:
  PACKAGE_PATH: /go/src/gitlab.com/iren.vasilevna/catalogue
 
  # https://docs.gitlab.com/ee/ci/docker/using_docker_build.html
  CONTAINER_TEST_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  CONTAINER_RELEASE_IMAGE: $CI_REGISTRY_IMAGE:latest
  GROUP: weaveworksdemos
  COMMIT: $CI_BUILD_REF
  TAG: $CI_COMMIT_TAG 
  REPO: catalogue
  MY_COOL_REGISTY: 10.128.0.9:5000

  #DOCKER_TLS_CERTDIR: ""
  DOCKER_TLS_CERTDIR: "/certs"
  #DOCKER_HOST: tcp://localhost:2375
  #DOCKER_HOST: tcp://10.128.0.9:2376
  #DOCKER_DRIVER: overlay2

image: $MY_COOL_REGISTY/custom-docker:dind
#image: golang:1.14.1-alpine
services:
  - name: docker:dind
    entrypoint: ["dockerd-entrypoint.sh"]
    command:  ["--insecure-registry=$MY_COOL_REGISTY"]
   # entrypoint: ["env", "-u", "DOCKER_HOST"]
    #command: ["dockerd-entrypoint.sh"]
  #- name: docker:dind


 #- name: 10.128.0.9:5000/custom-docker:dind




stages:
  - dep
  - test
  # - build
 
# A hack to make Golang-in-Gitlab happy
.anchors:
  - &inject-gopath
      mkdir -p $(dirname ${PACKAGE_PATH})
      && ln -s ${CI_PROJECT_DIR} ${PACKAGE_PATH}
      && cd ${PACKAGE_PATH}
 
dep:
  stage: dep
  tags:
#    - docker
  #services:
  #  - name: 10.128.0.9:5000/mydocker:dind
  #image: docker:stable 
  before_script:
    - *inject-gopath
  script: 
    - ls /etc/docker/certs.d
    - echo $repo_user
    - echo $DOCKER_HOST

   # - ls /etc/docker/certs.d/10.128.0.9:5000
    - docker login -u$repo_user -p$repo_pass 10.128.0.9:5000
    #- docker push 10.128.0.9:5000/alpine
    #- docker pull distribution/registry:master
    - docker version
    - docker build -t bolvan ./vendor
    - docker save -o bolvan.tar bolvan
    #- docker login -u$repo_user -p$repo_pass 10.128.0.9:5000 
    - docker tag bolvan 10.128.0.9:5000/bolvan:$CI_COMMIT_REF_SLUG
    - docker push 10.128.0.9:5000/bolvan:$CI_COMMIT_REF_SLUG

    #- apk update && apk add bash && apk add sudo
    #- go version

   # - go get -u github.com/FiloSottile/gvt      
   # - gvt restore
   # - go get -u github.com/mattn/goveralls
     
  #go mod tidy && go mod vendor
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - art/
    expire_in: 1 hour
    when: always

  after_script:
    - docker ps
    - docker images
 
test:
  stage: test
   
  only:
    - branches
 # except:
 #   - master
  image: instance-1:5000/bolvan:$CI_COMMIT_REF_SLUG

  dependencies:
    - dep
  script:
    - ls -a ./vendor
    - docker version

  after_script:
    - docker ps
    - docker images



